---
title: "SIM Project 2. Preprocessing"
author: "Adrià Casanova, Víctor Garcia, Zhengyong Ji"
date: "2023-12-02"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: no
editor_options:
  chunk_output_type: console
---

```{r, echo=T, message=FALSE, warning=FALSE, results='hide'}
# Clean the workspace
if(!is.null(dev.list())) dev.off()
rm(list = ls())
```

```{r}
# Import the libraries
library(dplyr) 
library(car)
library(DataExplorer)
```


```{r}
# Import the dataset
df = read.csv("WA_Fn-UseC_-Telco-Customer-Churn.xls",header=T, sep=",",
              stringsAsFactors=TRUE)
str(df)
summary (df)
```

# 1. Univariate Descriptive Analysis

```{r}
# The only numerical features that we have are tenure, MonthlyCharges and TotalChages.
numeric_val = c(6, 19, 20)

# So the remaining will be categorical feature.
categoric_val = c(names(df))
categoric_val = categoric_val[-c(1,numeric_val)]
```

```{r}
# Let's check the distribution of the numeric variables in order to discretize
# them in factors.


hist(df$TotalCharges)
hist(df$MonthlyCharges)
```


```{r}
par(mfrow=c(1,2))
hist(df$tenure, prob = TRUE, breaks = 10, main = 'Histogram of tenure 
     vs normal distribution', xlab = 'tenure')
x <- seq(min(df$tenure), max(df$tenure), by = .1)
y <- dnorm(x, mean = mean(df$tenure), sd = sd(df$tenure))
plot(x,y, xlab = 'tenuere', ylab = '')

hist(df$TotalCharges, prob = TRUE, breaks = 10, main = 'Hist totalCharges 
     vs normal distribution', xlab = 'TotalCharges')
x <- seq(min(df$TotalCharges, na.rm = TRUE), max(df$TotalCharges, na.rm = TRUE),
         by = 10)
y <- dnorm(x, mean = mean(df$TotalCharges, na.rm = TRUE), sd = sd(df$TotalCharges, na.rm = TRUE))
plot(x,y, xlab = 'TotalCharges', ylab = '')

hist(df$MonthlyCharges, prob = TRUE, breaks = 10, main = 'Hist MonthlyCharges 
     vs normal distribution', xlab = 'df$MonthlyCharges')
x <- seq(min(df$MonthlyCharges, na.rm = TRUE), max(df$MonthlyCharges, na.rm = TRUE),
         by = .1)
y <- dnorm(x, mean = mean(df$MonthlyCharges, na.rm = TRUE), sd = sd(df$MonthlyCharges, na.rm = TRUE))
plot(x,y, xlab = 'df$MonthlyCharges', ylab = '')

par(mfrow=c(1,1))
```

```{r}
# EDA for each variable (numeric and graphic)
summary(df)

# The plot of all variables can be seen in the report
#create_report(df, output_file = "Telco.html")
```

# 2. Data Quality Report

## Regarding variables
```{r}
# Distribution of missings in df
apply(sapply(df, is.na), 2, sum)
# Only TotalCharges has missings values, 11 in total.
```

```{r}
# We can check if there is any inconsistency in total charges.
# First, let's compute the expected total charges as the product of monthly
# charges and tenure
expected_total_charges = df$MonthlyCharges * df$tenure

# Then plot them against the actual total charges
plot(expected_total_charges, df$TotalCharges)
# There are no outliers, we can check this visually using boxplots
```

```{r}
id_num_val = c(6, 19, 20)
for (var in id_num_val) {
  Boxplot(df[,var], ylab = names(df)[var], main = "Boxplot") 
}
```


## Regarding Individuals

## Create variables with: nº of missings (of each individual), nº of outliers,
## nº of errors

Compute the correlation with all other variables. Rank these variables according
to the correlation

Compute for every group of individuals (group of age, size of town, singles,
married, …) the mean of missing/outliers/errors values. Rank the groups
according to the computed mean.

# Imputation

## Nmeric Variables

```{r}
sum(which(is.na(df$TotalCharges))) == sum(which(df$tenure == 0))
# Individuals with missing TotalCharges correspond to those whose tenure is 0, which means they are recently joined clients. In this situation, instead of NA, we can convert them to 0.

df$TotalCharges[which(is.na(df$TotalCharges))] = 0

# Now there aren't missing values
summary(df)
```

## Factors

# Profiling (target categories)

# Feature Selection
```{r}
# customerID should be removed
df$customerID <- NULL
```


# Modeling using numeric variables

```{r}
# Split df in train and test
```


---
title: "SIM Project 2. Preprocessing"
author: "Adrià Casanova, Víctor Garcia, Zhengyong Ji"
date: "2024-01-05"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: no
editor_options:
  chunk_output_type: console
---

```{r, echo=T, message=FALSE, warning=FALSE, results='hide'}
# Clean the workspace
if(!is.null(dev.list())) dev.off()
rm(list = ls())
```

```{r}
# Import the libraries
library(dplyr) 
library(car)
library(DataExplorer)
library(FactoMineR)
library(caTools)
```

```{r}
# Import the dataset
df = read.csv("WA_Fn-UseC_-Telco-Customer-Churn.xls",header=T, sep=",",
              stringsAsFactors=TRUE)
str(df)
summary(df)
```

```{r}
# The only numerical features that we have are tenure, MonthlyCharges and TotalChages.
numeric_val_idx = which(sapply(df, is.numeric))
numeric_val = names(df)[numeric_val_idx]

# So the remaining will be categorical features.
categoric_val_idx = which(sapply(df, is.factor))
categoric_val = names(df)[categoric_val_idx]
```

# 1. Univariate Descriptive Analysis

```{r}
# SeniorCitizen represents a qualitative concept, so we convert it to factor
df$SeniorCitizen <- factor(df$SeniorCitizen, labels = c("Yes", "No"))
```

```{r}
# Discretize numerical variables

# tenure
df$c.tenure <- df$tenure
m.tenure <- max(df$tenure, na.rm = TRUE)
df$c.tenure <- replace(df$c.tenure, df$tenure <= m.tenure/4, m.tenure/4)
for (i in 1:3) {
  idx <- (m.tenure*i/4 < df$tenure) & (df$tenure <= m.tenure*(i+1)/4)
  df$c.tenure <- replace(df$c.tenure, idx, m.tenure*(i+1)/4)
}
min(df$tenure, na.rm = TRUE)
breakpts <- seq(m.tenure/4, m.tenure, m.tenure/4); breakpts
df$c.tenure <- factor(df$c.tenure, labels = c("(-1,18]", "(18,36]",
                                              "(36,54]", "(54,72]"))
summary(df$c.tenure)
par(mfrow=c(1,2))
plot(df$c.tenure, main = "Barplot of df$c.tenure")
hist(df$tenure)
```

```{r}
# TotalCharges
df$c.TotalCharges <- df$TotalCharges
m.TotalCharges <- max(df$TotalCharges, na.rm = TRUE)
df$c.TotalCharges <- replace(df$c.TotalCharges, df$TotalCharges <= m.TotalCharges/4, m.TotalCharges/4)
for (i in 1:3) {
  idx <- (m.TotalCharges*i/4 < df$TotalCharges) & (df$TotalCharges <=
                                                     m.TotalCharges*(i+1)/4)
  df$c.TotalCharges <- replace(df$c.TotalCharges, idx, m.TotalCharges*(i+1)/4)
}
min(df$TotalCharges, ra.rm = TRUE)
breakpts <- seq(m.TotalCharges/4, m.TotalCharges, m.TotalCharges/4); breakpts
df$c.TotalCharges <- factor(df$c.TotalCharges, labels = c("(18,2171]",
                                                          "(2171,4342]", 
                                                          "(4342,6514]",
                                                          "(6514,8685]"))
summary(df$c.TotalCharges)
par(mfrow=c(1,2))
plot(df$c.TotalCharges, main = "Barplot of df$c.TotalCharges")
hist(df$TotalCharges)
```

```{r}
# MonthlyCharges
df$c.MonthlyCharges <- df$MonthlyCharges
m.MonthlyCharges <- max(df$MonthlyCharges, na.rm = TRUE)
df$c.MonthlyCharges <- replace(df$c.MonthlyCharges, df$MonthlyCharges <= m.MonthlyCharges/4, m.MonthlyCharges/4)
for (i in 1:3) {
  idx <- (m.MonthlyCharges*i/4 < df$MonthlyCharges) & (df$MonthlyCharges <=
                                                       m.MonthlyCharges*(i+1)/4)
  df$c.MonthlyCharges <- replace(df$c.MonthlyCharges, idx,
                                 m.MonthlyCharges*(i+1)/4)
}
min(df$MonthlyCharges, na.rm = TRUE)
breakpts <- seq(m.MonthlyCharges/4, m.MonthlyCharges, m.MonthlyCharges/4)
breakpts
df$c.MonthlyCharges <- factor(df$c.MonthlyCharges, labels = c("(18,30.69]",
                                                          "(30.69,59.38]", 
                                                          "(59.38,89.06]",
                                                          "(89.06,118.75]"))
summary(df$c.MonthlyCharges)
par(mfrow=c(1,2))
plot(df$c.MonthlyCharges, main = "Barplot of df$c.MonthlyCharges")
hist(df$MonthlyCharges)
par(mfrow=c(1,1))
```

```{r}
hist(df$TotalCharges)
hist(df$MonthlyCharges)
```

```{r}
par(mfrow=c(1,2))
hist(df$tenure, prob = TRUE, breaks = 10, main = 'Histogram of tenure 
     vs normal distribution', xlab = 'tenure')
x <- seq(min(df$tenure), max(df$tenure), by = .1)
y <- dnorm(x, mean = mean(df$tenure), sd = sd(df$tenure))
plot(x,y, xlab = 'tenuere', ylab = '')

hist(df$TotalCharges, prob = TRUE, breaks = 10, main = 'Hist totalCharges 
     vs normal distribution', xlab = 'TotalCharges')
x <- seq(min(df$TotalCharges, na.rm = TRUE), max(df$TotalCharges, na.rm = TRUE),
         by = 10)
y <- dnorm(x, mean = mean(df$TotalCharges, na.rm = TRUE), sd = sd(df$TotalCharges, na.rm = TRUE))
plot(x,y, xlab = 'TotalCharges', ylab = '')

hist(df$MonthlyCharges, prob = TRUE, breaks = 10, main = 'Hist MonthlyCharges 
     vs normal distribution', xlab = 'df$MonthlyCharges')
x <- seq(min(df$MonthlyCharges, na.rm = TRUE), max(df$MonthlyCharges, na.rm = TRUE),
         by = .1)
y <- dnorm(x, mean = mean(df$MonthlyCharges, na.rm = TRUE), sd = sd(df$MonthlyCharges, na.rm = TRUE))
plot(x,y, xlab = 'df$MonthlyCharges', ylab = '')

par(mfrow=c(1,1))
```

```{r}
# EDA for each variable (numeric and graphic)
summary(df)

# The plot of all variables can be seen in the report
#create_report(df, output_file = "Telco.html")
```




# 2. Data Quality Report

## Regarding variables
```{r}
# Distribution of missings in df
apply(sapply(df, is.na), 2, sum)
# Only TotalCharges has missings values, 11 in total.
```

```{r}
# We can check if there is any inconsistency in total charges.
# First, let's compute the expected total charges as the product of monthly
# charges and tenure
expected_total_charges = df$MonthlyCharges * df$tenure

# Then plot them against the actual total charges
plot(expected_total_charges, df$TotalCharges)
# There are no outliers, we can check this visually using boxplots
```

```{r}
id_num_val = c(6, 19, 20)
for (var in id_num_val) {
  Boxplot(df[,var], ylab = names(df)[var], main = "Boxplot") 
}
```


## Regarding Individuals

## Create variables with: nº of missings (of each individual), nº of outliers,
## nº of errors

Compute the correlation with all other variables. Rank these variables according
to the correlation

Compute for every group of individuals (group of age, size of town, singles,
married, …) the mean of missing/outliers/errors values. Rank the groups
according to the computed mean.

# Imputation

## Numeric Variables

```{r}
sum(which(is.na(df$TotalCharges))) == sum(which(df$tenure == 0))
# Individuals with missing TotalCharges correspond to those whose tenure is 0, 
# which means they are recently joined clients. 
# In this situation, instead of NA, we can convert them to 0.

df$TotalCharges[which(is.na(df$TotalCharges))] = 0

# Now there are no more missing values
summary(df)
```

## Factors

# Profiling (target categories)

# Feature Selection
```{r}
# customerID should be removed
df$customerID <- NULL

# Execute catdes function to find the correlation between the variables 
# against our qualitative target Churn.
res.cat = catdes(df, 20)

# Through sqrt_chi test, we can rank the most influential feature.
res.cat$test.chi2

# The outcome of Chi sqrt test proved that all the categorical feature are meanfull (p-value > 0.05)
# The key feature are the "Contract" period type, followed by "OnlineSecurity" and the "TechSupport".

res.cat$quanti.var
# And the correlation of numerical variable are also important.
```



# Modeling using numeric variables

```{r}
# First, let's split the dataset into training and testing. 
# We can consider that 70% of data will be used for training purpose.

set.seed(123)

sampling = sample.split(df$Churn, SplitRatio = 0.7)
train = subset(df, sampling == TRUE)
test = subset(df, sampling == FALSE)
```


```{r}
# Let's start with our first model, considering all the features.

m0 = glm (Churn ~., data = train, family = binomial )
summary(m0)
```


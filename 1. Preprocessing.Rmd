---
title: "SIM Project 2. Preprocessing"
author: "Adrià Casanova, Víctor Garcia, Zhengyong Ji"
date: "2024-01-05"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: no
editor_options:
  chunk_output_type: console
---

```{r, echo=T, message=FALSE, warning=FALSE, results='hide'}
# Clean the workspace
if(!is.null(dev.list())) dev.off()
rm(list = ls())
```

```{r}
# Import the libraries and other sources
library(dplyr) 
library(car)
library(DataExplorer)
library(FactoMineR)
library(caTools)
library(chemometrics)
library(corrplot)
source("profiling_func.R")
```

```{r}
# Import the dataset
df = read.csv("WA_Fn-UseC_-Telco-Customer-Churn.xls",header=T, sep=",",
              stringsAsFactors=TRUE)
str(df)
summary(df)
```

# 1. Univariate Descriptive Analysis

```{r}
# SeniorCitizen represents a qualitative concept, so we convert it to factor
df$SeniorCitizen <- factor(df$SeniorCitizen, labels = c("Yes", "No"))
```

```{r}
# Discretize numerical variables

# tenure
df$c.tenure <- df$tenure
m.tenure <- max(df$tenure, na.rm = TRUE)
df$c.tenure <- replace(df$c.tenure, df$tenure <= m.tenure/4, m.tenure/4)
for (i in 1:3) {
  idx <- (m.tenure*i/4 < df$tenure) & (df$tenure <= m.tenure*(i+1)/4)
  df$c.tenure <- replace(df$c.tenure, idx, m.tenure*(i+1)/4)
}
min(df$tenure, na.rm = TRUE)
breakpts <- seq(m.tenure/4, m.tenure, m.tenure/4); breakpts
df$c.tenure <- factor(df$c.tenure, labels = c("(-1,18]", "(18,36]",
                                              "(36,54]", "(54,72]"))
summary(df$c.tenure)
par(mfrow=c(1,2))
plot(df$c.tenure, main = "Barplot of df$c.tenure")
hist(df$tenure)
```

```{r}
# TotalCharges
df$c.TotalCharges <- df$TotalCharges
m.TotalCharges <- max(df$TotalCharges, na.rm = TRUE)
df$c.TotalCharges <- replace(df$c.TotalCharges, df$TotalCharges <= m.TotalCharges/4, m.TotalCharges/4)
for (i in 1:3) {
  idx <- (m.TotalCharges*i/4 < df$TotalCharges) & (df$TotalCharges <=
                                                     m.TotalCharges*(i+1)/4)
  df$c.TotalCharges <- replace(df$c.TotalCharges, idx, m.TotalCharges*(i+1)/4)
}
breakpts <- seq(m.TotalCharges/4, m.TotalCharges, m.TotalCharges/4); breakpts
df$c.TotalCharges <- factor(df$c.TotalCharges, labels = c("(-1,2171]",
                                                          "(2171,4342]", 
                                                          "(4342,6514]",
                                                          "(6514,8685]"))
summary(df$c.TotalCharges)
par(mfrow=c(1,2))
plot(df$c.TotalCharges, main = "Barplot of df$c.TotalCharges")
hist(df$TotalCharges)
```

```{r}
# MonthlyCharges
df$c.MonthlyCharges <- df$MonthlyCharges
m.MonthlyCharges <- max(df$MonthlyCharges, na.rm = TRUE)
df$c.MonthlyCharges <- replace(df$c.MonthlyCharges, df$MonthlyCharges <= m.MonthlyCharges/4, m.MonthlyCharges/4)
for (i in 1:3) {
  idx <- (m.MonthlyCharges*i/4 < df$MonthlyCharges) & (df$MonthlyCharges <=
                                                       m.MonthlyCharges*(i+1)/4)
  df$c.MonthlyCharges <- replace(df$c.MonthlyCharges, idx,
                                 m.MonthlyCharges*(i+1)/4)
}
min(df$MonthlyCharges, na.rm = TRUE)
breakpts <- seq(m.MonthlyCharges/4, m.MonthlyCharges, m.MonthlyCharges/4)
breakpts
df$c.MonthlyCharges <- factor(df$c.MonthlyCharges, labels = c("(18,30.69]",
                                                          "(30.69,59.38]", 
                                                          "(59.38,89.06]",
                                                          "(89.06,118.75]"))
summary(df$c.MonthlyCharges)
par(mfrow=c(1,2))
plot(df$c.MonthlyCharges, main = "Barplot of df$c.MonthlyCharges")
hist(df$MonthlyCharges)
par(mfrow=c(1,1))
```

```{r, eval = FALSE}
par(mfrow=c(1,2))
hist(df$tenure, prob = TRUE, breaks = 10, main = 'Histogram of tenure 
     vs normal distribution', xlab = 'tenure')
x <- seq(min(df$tenure), max(df$tenure), by = .1)
y <- dnorm(x, mean = mean(df$tenure), sd = sd(df$tenure))
plot(x,y, xlab = 'tenuere', ylab = '')

hist(df$TotalCharges, prob = TRUE, breaks = 10, main = 'Hist totalCharges 
     vs normal distribution', xlab = 'TotalCharges')
x <- seq(min(df$TotalCharges, na.rm = TRUE), max(df$TotalCharges, na.rm = TRUE),
         by = 10)
y <- dnorm(x, mean = mean(df$TotalCharges, na.rm = TRUE), sd = sd(df$TotalCharges, na.rm = TRUE))
plot(x,y, xlab = 'TotalCharges', ylab = '')

hist(df$MonthlyCharges, prob = TRUE, breaks = 10, main = 'Hist MonthlyCharges 
     vs normal distribution', xlab = 'df$MonthlyCharges')
x <- seq(min(df$MonthlyCharges, na.rm = TRUE), max(df$MonthlyCharges, na.rm = TRUE),
         by = .1)
y <- dnorm(x, mean = mean(df$MonthlyCharges, na.rm = TRUE), sd = sd(df$MonthlyCharges, na.rm = TRUE))
plot(x,y, xlab = 'df$MonthlyCharges', ylab = '')

par(mfrow=c(1,1))
```

```{r}
# The only numerical features that we have are tenure, MonthlyCharges and TotalChages.
numeric_val_idx = which(sapply(df, is.numeric))
numeric_val = names(df)[numeric_val_idx]

# So the remaining will be categorical features.
categoric_val_idx = which(sapply(df, is.factor))
categoric_val = names(df)[categoric_val_idx]
```

```{r}
# EDA for each variable (numeric and graphic)
summary(df)

# The plot of all variables can be seen in the report
#create_report(df, output_file = "Telco.html")

# In the report we can see that no numeric variable has a normal distribution,
# so there is no need to perform any test on their normality.
```



# 2. Data Quality Report

## Regarding variables
```{r}
# Distribution of missings in df
apply(sapply(df, is.na), 2, sum)
# Only TotalCharges and hence c.TotalCharges have missings values, 22 in total.
```

```{r}
# We can check if there are inconsistencies in total charges. That is the only
# variable that could have any.
# First, let's compute the expected total charges as the product of monthly
# charges and tenure
expected_total_charges = df$MonthlyCharges * df$tenure

# Then plot them against the actual total charges
plot(expected_total_charges, df$TotalCharges)
# There are no outliers, so TotalCharges is consistent.
```

```{r}
# Outliers
for (var in as.numeric(numeric_val_idx)) {
  Boxplot(df[,var], ylab = names(df)[var], main = "Boxplot") 
}
# There aren't univariate outliers
```

## Regarding Individuals

```{r}
# Distribution of missings
table(apply(sapply(df, is.na), 1, sum))
# As could be deduced from the distribution of missings per variable, only
# eleven records have missings. Precisely, these individuals have an na value
# for TotalCharges and c.TotalCharges. We can find them.
which(is.na(df$TotalCharges))
```

To look for multivariant outliers, we need to impute or remove all our missing
data, so we will conduct a search later.

## Create variables with: nº of missings (of each individual), nº of outliers,
## nº of errors

```{r}
df$n.na <- apply(sapply(df, is.na), 1, sum)
df$n.outliers <- rep(0,dim(df)[1])
df$n.errors <- rep(0,dim(df)[1])
```

We will compute the correlation between these new variables and the rest of
variables in the data frame after imputing.

Next, we will compute for every group of individuals the mean of missing values. Then we will rank the groups according to the computed mean.

```{r}
# c.TotalCharges has missings, so it doesn't make sense to compute the mean
# of missings in its categories

interesting_cat_idx <- categoric_val_idx[-c(1,20)]
k = 0
for (i in interesting_cat_idx){
  k <- k + length(levels(df[,i]))
}
groups.na <- matrix(0, k, 2)
l = 1
for (i in seq(length(interesting_cat_idx))) {
  idx <- interesting_cat_idx[i]
  categories.na <- tapply(df$n.na, df[,idx], mean)
  for (j in seq(length(categories.na))) {
    groups.na[l + j - 1,] <- c(as.numeric(categories.na[j]),
                               paste(names(df)[idx], levels(df[,idx])[j],
                                     sep = "."))
  }
  l <- l + j
}
groups.na.df <- data.frame(na.perc = groups.na[,1], group = groups.na[,2])
groups.na.df[order(groups.na.df$na.perc, decreasing = TRUE),]
```


# Imputation

## Numeric Variables

```{r}
TotalCharges.na <- which(is.na(df$TotalCharges))
sum(TotalCharges.na == which(df$tenure == 0)) == length(TotalCharges.na)
# Individuals with missing TotalCharges correspond to those whose tenure is 0, 
# which means they are recently joined clients. 
# In this situation, instead of NA, we can convert them to 0.

na.idx <- which(is.na(df$TotalCharges))
df$TotalCharges[na.idx] = 0
df$c.TotalCharges[na.idx] = "(-1,2171]"

# Now there are no more missing values
summary(df)
```

```{r}
# Let's look at the correlation between our variables, specially between
# the ones created for the data quality report and the rest of them.
corr_mat <- cor(df[,c(numeric_val_idx, 25)],)
corr_mat

corrplot(corr_mat, order = 'hclust')
# n.na isn't related to any other variable. However, TotalCharges is both
# related to tenure and MonthlyCharges. We already saw this phenomenon when
# we ploted TotalCharges against tenure*MonthlyCharges.
```


```{r}
# Let's look for multiavariant outliers
set.seed(123)
res.mout <- Moutlier(df[,numeric_val_idx], quantile = 0.95, plot= FALSE)

par(mfrow=c(1,2))
plot(res.mout$md, col="lightblue", pch = 19, main = 'Detection of multivariable 
outliers', xlab= 'Observation', 
     ylab ='Traditional Mahalanobis distance ')
abline(h = res.mout$cutoff, col = "red", lwd = 5, lty = 2)

plot(res.mout$rd, col="lightblue", pch = 19, xlab= 'Observation', 
     ylab ='Robust Mahalanobis distance ')
abline(h = res.mout$cutoff, col = "red", lwd = 5, lty = 2)
par(mfrow=c(1,1))

outliers = which(res.mout$md>res.mout$cutoff & res.mout$rd > res.mout$cutoff) 
length(outliers)
length(outliers)/dim(df)[1]*100
# There are 344 multivariant outliers, about 5% of the individuals.
```

```{r}
# After the report, we remove the newly created variables to don't interfere
# in the rest of the project
df$n.na <- NULL
df$n.errors <- NULL
df$n.outliers <- NULL
```


# Profiling (target categories)

```{r}
profiling(df[-1], df$Churn, "Churn")
```


# Feature Selection
```{r}
# customerID should be removed
df$customerID <- NULL

# Execute catdes function to find the correlation between the variables 
# against our qualitative target Churn.
res.cat = catdes(df, 20)

# Through sqrt_chi test, we can rank the most influential feature.
res.cat$test.chi2

# The outcome of Chi sqrt test proved that all the categorical feature are meanfull (p-value > 0.05)
# The key feature are the "Contract" period type, followed by "OnlineSecurity" and the "TechSupport".

res.cat$quanti.var
# And the correlation of numerical variable are also important.
```



# Modeling using numeric variables

```{r}
# First, let's split the dataset into training and testing. 
# We can consider that 70% of data will be used for training purpose.

set.seed(123)

sampling = sample.split(df$Churn, SplitRatio = 0.7)
train = subset(df, sampling == TRUE)
test = subset(df, sampling == FALSE)
```


```{r}
# The first model will be with all the original variables.

m0 = glm (Churn ~., data = train[,1:20], family = binomial)
summary(m0)

# The second model will be with all the categorical variable, including the discretized value (the numerical's ones).

m0.c = glm (Churn ~., data = train[,-c(5,18,19)], family = binomial)
summary(m0.c)

# Compare the difference of these two model with AIC criteria.
AIC (m0, m0.c)

# The AIC parameter for both model are quite similar, although the m0 is slightly better. Hence, we'll use the original dataset, without discretizing the numerical variable.

# As the two model are not nested, we cannot apply the anova test
# anova (m0, m0.c, test = "Chisq")
```

The AIC criteria shows that using numerical variables or discretized variables cannot make much difference. In this situation, in order to reduce the workload, we decided to use the discretized variables (hence, we'll have only categorical variable)

```{r}
# Next step is to do the net-effect.
```


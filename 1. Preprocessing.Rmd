---
title: "SIM Project 2. Preprocessing"
author: "Adrià Casanova, Víctor Garcia, Zhengyong Ji"
date: "2023-12-02"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: no
editor_options:
  chunk_output_type: console
---

```{r, echo=T, message=FALSE, warning=FALSE, results='hide'}
# Clean the workspace
if(!is.null(dev.list())) dev.off()
rm(list = ls())
```

```{r}
# Import the libraries
library(dplyr) 
```

```{r}
# Import the dataset
df = read.csv("WA_Fn-UseC_-Telco-Customer-Churn.xls",header=T, sep=",",
              stringsAsFactors=TRUE)
str(df)
summary(df)
```

```{r}
# The only numerical features that we have are tenure, MonthlyCharges and TotalChages.
numeric_val_idx = which(sapply(df, is.numeric))
numeric_val = names(df)[numeric_val_idx]

# So the remaining will be categorical features.
categoric_val_idx = which(sapply(df, is.factor))
categoric_val = names(df)[categoric_val_idx]
```

# 1. Univariate Descriptive Analysis

```{r}
# SeniorCitizen represents a qualitative concept, so we convert it to factor
df$SeniorCitizen <- factor(df$SeniorCitizen, labels = c("Yes", "No"))
```

```{r}
# Discretize numerical variables

# tenure
df$c.tenure <- df$tenure
m.tenure <- summary(df$tenure)[6]
df$c.tenure <- replace(df$c.tenure, df$tenure <= m.tenure/4, m.tenure/4)
for (i in 1:3) {
  idx <- (m.tenure*i/4 < df$tenure) & (df$tenure <= m.tenure*(i+1)/4)
  df$c.tenure <- replace(df$c.tenure, idx, m.tenure*(i+1)/4)
}
summary(df$tenure)[1]
breakpts <- seq(m.tenure/4, m.tenure, m.tenure/4); breakpts
df$c.tenure <- factor(df$c.tenure, labels = c("(-1,18]", "(18,36]",
                                              "(36,54]", "(54,72]"))
summary(df$c.tenure)
par(mfrow=c(1,2))
plot(df$c.tenure, main = "Barplot of df$c.tenure")
hist(df$tenure)
```

```{r}
# TotalCharges
df$c.TotalCharges <- df$TotalCharges
m.TotalCharges <- summary(df$TotalCharges)[6]
df$c.TotalCharges <- replace(df$c.TotalCharges, df$TotalCharges <= m.TotalCharges/4, m.TotalCharges/4)
for (i in 1:3) {
  idx <- (m.TotalCharges*i/4 < df$TotalCharges) & (df$TotalCharges <=
                                                     m.TotalCharges*(i+1)/4)
  df$c.TotalCharges <- replace(df$c.TotalCharges, idx, m.TotalCharges*(i+1)/4)
}
summary(df$TotalCharges)[1]
breakpts <- seq(m.TotalCharges/4, m.TotalCharges, m.TotalCharges/4); breakpts
df$c.TotalCharges <- factor(df$c.TotalCharges, labels = c("(18,2171]",
                                                          "(2171,4342]", 
                                                          "(4342,6514]",
                                                          "(6514,8685]"))
summary(df$c.TotalCharges)
par(mfrow=c(1,2))
plot(df$c.TotalCharges, main = "Barplot of df$c.TotalCharges")
hist(df$TotalCharges)
```

```{r}
# MonthlyCharges
df$c.MonthlyCharges <- df$MonthlyCharges
m.MonthlyCharges <- summary(df$MonthlyCharges)[6]
df$c.MonthlyCharges <- replace(df$c.MonthlyCharges, df$MonthlyCharges <= m.MonthlyCharges/4, m.MonthlyCharges/4)
for (i in 1:3) {
  idx <- (m.MonthlyCharges*i/4 < df$MonthlyCharges) & (df$MonthlyCharges <=
                                                       m.MonthlyCharges*(i+1)/4)
  df$c.MonthlyCharges <- replace(df$c.MonthlyCharges, idx,
                                 m.MonthlyCharges*(i+1)/4)
}
summary(df$MonthlyCharges)[1]
breakpts <- seq(m.MonthlyCharges/4, m.MonthlyCharges, m.MonthlyCharges/4)
breakpts
df$c.MonthlyCharges <- factor(df$c.MonthlyCharges, labels = c("(18,30.69]",
                                                          "(30.69,59.38]", 
                                                          "(59.38,89.06]",
                                                          "(89.06,118.75]"))
summary(df$c.MonthlyCharges)
par(mfrow=c(1,2))
plot(df$c.MonthlyCharges, main = "Barplot of df$c.MonthlyCharges")
hist(df$MonthlyCharges)
```

```{r}
# EDA for each variable (numeric and graphic)
```

# 2. Data Quality Report

## Regarding variables
```{r}
# Distribution of missings in df
apply(sapply(df, is.na), 2, sum)
# Only TotalCharges has missings values, 11 in total.
```

```{r}
# We can check if there is any inconsistency in total charges.
# First, let's compute the expected total charges as the product of monthly
# charges and tenure
expected_total_charges = df$MonthlyCharges * df$tenure

# Then plot them against the actual total charges
plot(expected_total_charges, df$TotalCharges)
# There are no outliers.
```

## Regarding Individuals

## Create variables with: nº of missings (of each individual), nº of outliers,
## nº of errors

Compute the correlation with all other variables. Rank these variables according
to the correlation

Compute for every group of individuals (group of age, size of town, singles,
married, …) the mean of missing/outliers/errors values. Rank the groups
according to the computed mean.

# Imputation

## Nmeric Variables

```{r}
sum(which(is.na(df$TotalCharges))) == sum(which(df$tenure == 0))
# Individuals with missing TotalCharges correspond to those whose tenure is 0, which means they are recently joined clients. In this situation, instead of NA, we can convert them to 0.

df$TotalCharges[which(is.na(df$TotalCharges))] = 0

# Now there aren't missing values
summary(df)
```

## Factors

# Profiling (target categories)

# Feature Selection
```{r}
# customerID should be removed
df$customerID <- NULL
```


# Modeling using numeric variables

```{r}
# Split df in train and test
```

